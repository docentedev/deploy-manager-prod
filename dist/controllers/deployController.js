/* claudio.dcv@gmail.com */
"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const s=e(require("fs")),t=require("child_process"),o=e(require("stream")),r=require("../db/models");async function n(e,t,o,n){try{const p=await r.EnvConfiguration.findOne(),{baseDir:d,script:l}=n,f=e.user,m=[];if(!s.default.existsSync(d))return u(t,m,`El directorio base ${d} no existe.`,400);const y=i(l,null==p?void 0:p.variables);await c(y,d,m,o),await a(f.id,n.id,m,"success"),t.json({success:!0,message:"API deploy completed"})}catch(e){const s=e instanceof Error?e.message:"Error desconocido";t.status(500).json({success:!1,error:s})}}function i(e,s){return`${(null==s?void 0:s.map((({key:e,value:s})=>`export ${e}="${s.replace(/"/g,'\\"')}"`)).join("\n"))||""}\n${e.replace(/\r\n?/g,"\n")}`}function u(e,s,t,o){s.push(t),e.status(o).json({success:!1,error:t})}async function c(e,s,r,n){return new Promise(((i,u)=>{const c=new o.default.Readable;c.push(e),c.push(null);const a=(0,t.spawn)("sh",[],{cwd:s,stdio:["pipe","pipe","pipe"]});c.pipe(a.stdin),a.stdout.on("data",(e=>{const s=e.toString().trim();r.push(s),null==n||n.emit("deploy-api",{type:"stdout",message:s})})),a.stderr.on("data",(e=>{const s=e.toString().trim();r.push(s),null==n||n.emit("deploy-api",{type:"stderr",message:s})})),a.on("close",(e=>{if(0===e)i();else{const s=`Script exited with code ${e}`;r.push(s),u(new Error(s))}})),a.on("error",(e=>{const s=e.toString();r.push(s),u(new Error(s))}))}))}async function a(e,s,t,o){const n=t.join("\n");await r.DeployLog.create({userId:e,deployConfigId:s,output:n,status:o})}module.exports={deployApi:n};